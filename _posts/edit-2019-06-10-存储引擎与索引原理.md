---
layout:     post
title:      MySQL 存储引擎与索引原理
subtitle:   学习笔记
date:       2019-06-10
author:     sincosmos
header-img: img/post-bg-map.jpg
catalog: true
tags:
    - MySQL，存储引擎，B 树，B+ 树
---

参考资料 [MySQL索引背后的数据结构及算法原理](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)  
MySQL 常用的存储引擎有 MyISAM 和 InnoDB。MyISAM 不支持事务，在更新时使用表级锁，查询速度很快，适合更新少，查询多的业务场景；InnoDB 支持事务和行级锁，因此更适合并发操作和更新较多的业务场景。另外，MyISAM 不支持外键关联。索引是存储引擎级别的实现，不同的存储引擎可能采用不同的索引类型和实现方式。B+ 树是大多数 mysql 存储引擎默认的索引类型。
## B-Tree / B+ Tree
B-tree is a fat tree. The height of B-Trees is kept low by putting maximum possible keys in a B-Tree node. Generally, a B-Tree node size is kept equal to the disk block size. Since h is low for B-Tree, total disk accesses for most of the operations are reduced significantly compared to balanced Binary Search Trees like AVL Tree, Red-Black Tree, ..etc.  
In B Tree, Keys and records both can be stored in the internal as well as leaf nodes. Whereas, in B+ tree, records (data) can only be stored on the leaf nodes while internal nodes can only store the key values. The leaf nodes of a B+ tree are linked together in the form of a singly linked lists to make the search queries more efficient.  
为什么 Mysql 索引用 B+ 树而不是 B 树？B 树的节点需要存储数据，而 B+ 树只有叶子结点存储数据，这样在节点大小（通常是磁盘页的大小）一定的情况下，B 树内部节点能存储的索引数量就大大少于 B+ 树内部节点存储的索引的数量，导致同样的检索，B 树很可能要读更多的页，即磁盘 IO 次数回增多，检索效率下降。另外 B+ 树的叶子节点会顺序存储下一个叶子节点的地址指针，在区间访问时，能够进一步减少磁盘 IO 次数。
下面是 B 树节点的实现代码  

```

```
## 索引
1) 假设在表 A 上经常用到的两个查询语句是 select colx from A where col2=? and col1=? 和 select coly from A where col1 like 'sample%'，应该怎么建立索引比较好？可以考虑建立一个联合索引，create index composite_index_cols on A (col1, col2)。对于前者来说，SQL 解析器会自动调整两个条件的顺序，这样两个查询都能用到这个索引，加快查询效率。
2) MyISAM 的主键索引和非主键索引都是非聚簇索引，叶子节点数据区存放的都是数据地址。一个 MyISAM 的表会被存放为三个以表名命名的物理文件，.frm 文件记录表结构定义信息，.MYD 文件存放表的数据，.MYI 文件存放表的索引。InnoDB 的主键索引是聚簇索引，叶子节点的数据就是数据本身，非主键索引是非聚簇索引，数据区存放的是主键。因此 MyISAM 表可以没有主键，而 InnoDB 的表如果不指定主键，则会由存储引擎生成一个全局的 rowid 序列作为主键，所有不指定主键的表共享同一个 rowid 序列，并发性能差，因此一般都需要指定主键。一个 InnoDB 的表会被存储为两个物理文件，.frm 文件记录表结构，.ibd (独享表)或 ibdata（共享表） 文件存储表数据和索引；另外，InnoDB 还有事务日志信息文件，可以通过 redo 日志和表中 undo 信息进行事务管理或数据库恢复(数据库恢复时，采用 checkpoint 机制，即 checkpoint 之前的操作已经持久化到磁盘，数据库恢复不用重做所有的 redo 日志，只需按照 checkpoint 之后的操作进行恢复即可)。
3) 联合索引实际上是按照联合索引的第一列建立 B+ 树，非叶子节点上的 key 是第一列的值，叶子节点上保存了联合索引中所有列的值并按照第一列、第二列...依次排序。