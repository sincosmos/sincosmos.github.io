# 分布式理论 
## CAP 定理
CAP 原则又称 CAP 定理，指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）这三个基本需求，最多只能同时满足其中的2个
## BASE 理论
Basically Available（基本可用），Soft state（软状态）和 Eventually Consistent（最终一致性，例如因果一致性，读已之所写，会话一致性，单调读一致性，单调写一致性）
## 2PC 协议
分为两个阶段提交一个事务，并通过协调者和各个参与者配合，实现分布式一致性。
第一阶段为提交事务请求阶段（投票阶段，Propose）
a. 事务询问，协调者像所有的参与者询问，是否准备好了执行事务，并开始等待各参与者的响应；
b. 执行事务，各个参与者执行事务操作，如果本地事务执行成功，则记录 Undo 和 Redo 日志，但不提交，如果本地事务失败，退出事务执行；
c. 参与者向协调者反馈事务询问的响应（投票结果），成功则表明事务可以提交（Yes），失败则表示事务不能提交(No)。
第二阶段为执行事务提交阶段（执行阶段，Commit），根据第一个阶段的投票结果:
a. 如果全部参与者都返回可以执行(Yes)，则协调者向所有参与者发送 commit 请求 -> 参与者收到 commit 后执行事务提交操作 -> 参与者完成事务提交后，向协调者发送 Ack -> 所有参与者都成功提交事务，事务完成
b. 如果有参与者返回投票事务不可提交（No），则协调者会向所有参与者发送事务回滚请求。
2PC 的优点是概念原理简单。缺点是同步阻塞（所有节点都要等待其它节点的反馈后才能继续执行）、单点问题（协调者在整个二阶段提交过程中至关重要，如果协调者出现问题，那么整个流程将无法运转，另外，其它参与者会一直处于锁定事务资源状态，无法继续完成事务操作）、数据不一致（假设当协调者向所有参与者发送 commit 请求后，发生局部网络异常导致只有部分参与者收到了 commit 请求，或者协调者只向部分参与者发送 commit 请求后发生崩溃，将导致严重的数据不一致问题）
## 3PC 协议
3PC 主要是把 2PC 提交事务请求阶段一分为二，形成了 PreCommit 和 DoCommit 这两个阶段，再加上第一阶段的 Propose 作为 Cancommit 阶段，形成了 3PC。3PC 相当于在 2PC 的 commit 阶段里增加了一个 barrier，即相当于确认每一个参与者都接收到了 commit 的决策后才提交，避免数据不一致。
阶段一 CanCommit 阶段，事务询问（协调者向所有参与者发送一个包含事务内容的 canCommit 请求，询问是否可以执行事务提交操作，并等待参与者响应） -> 各参与者向协调者反馈事务询问应答（自己是否可以顺利执行事务？Yes or No）
阶段二 PreCommit 阶段，根据 CanCommit 结果  
	a. 如果全部参与者返回 Yes，则协调者所有参与者发送预提交 -> 参与者收到预提交请求后，执行事务操作，并保存 Undo 和 Redo 日志 -> 参与者向协调者反馈事务执行响应(Ack) -> 参与者开始等待最终的 commit 或 abort 命令
	b. 假设任何一个参与者返回了 No 或等待超时，则协调者向所有参与者发送中断事务请求 -> 参与者中断事务 -> 事务完成
阶段三 DoCommit 阶段
	a. 如果协调者接收到了所有参与者的 Ack 反馈，那么它将从预提交转换到提交状态，并向所有的参与者发送 DoCommit 请求 -> 参与者进行事务提交 -> 反馈事务提交结果 -> 完成事务
	b. 如果任何一个参与者向协调者反馈了 No 或反馈等待超时，那么协调者向所有参与者发送 abort 请求 -> 参与者进行事务回滚 -> 参与者回滚完成后向协调者发送 Ack 消息 -> 协调者接受到所有参与者的 Ack 后，中断事务完成。
进入阶段三后，可能会存在以下两种故障：协调者崩溃或协调者和参与者之间出现网络故障。无论哪种故障出现，都会导致参与者无法及时接受来自协调者的 commit 或 abort 最终命令，针对这种异常情况，参与者都会在等待超时后，继续进行事务提交操作。
3PC相较于2PC，降低了参与者的阻塞范围，并且在单点（协调者）故障时但事务可提交时继续达成一致。但如果协调者最终发送了 abort 命令只被部分参与者收到，那么还会造成数据不一致。
## 一致性算法 Paxos 
2PC 和 3PC 都存在数据不一致问题，Paxos 算法保证整个系统的最终一致。Paxos 将系统成员分为 Proposer（可以提出提案 Proposal，Proposal 对应的值为 value）, Acceptor (可以接受提案，即被接受的提案 value 会成为分布式系统中存储的值), Learner（Acceptor 告诉 Learner 哪个提案被选定，那么 Learner 会更新为相应提案的值） 三种角色。在具体的实现中，一个进程就是一个系统成员，其既可以是 Proposer，也可以是 Acceptor，也可以是 Learner。