---
layout:     post
title:      云原生微服务技术
subtitle:   学习笔记
date:       2019-11-07
author:     sincosmos
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - Kubernetes, ServiceMesher, Istio
---  

## ServiceMesher(服务网格)  
1. 服务网格是用于处理服务间通信的专用基础设施层  
2. 服务网格中分为控制平面和数据平面，当前流行的两款开源服务网格 Istio 和 Linkerd 实际上都是这种构造。  
   ![服务网格架构](https://jimmysong.io/istio-handbook/images/0069RVTdly1fuail4d24jj31080rkgr7.jpg)  
   控制平面不直接解析数据包；与控制平面中的代理通信，下发策略和配置；负责网络行为的可视化；通常提供 API 或者命令行工具可用于配置版本化管理，便于持续集成和部署。  
   数据平面通常是按照无状态目标设计的，但实际上位了提高流量转发性能，需要缓存一些数据，因此无状态也是有争议的；直接处理入站和出站的数据包，转发、路由、健康检查、负载均衡、认证、鉴权、产生监控数据；对应用来说是透明的，可以做到无感知部署。
   
## Istio
1. Istio 可以在虚拟机和容器中运行。  
2. Istio 的组成
- Pilot: 服务发现，流量管理
- Mixer: 访问控制，遥测
- Citadel: 终端用户认证、流量加密
Istio 作为控制平面，在每个服务中注入一个 Envoy 代理以 Sidecar 形式运行，拦截所有进出服务的流量，同事对流量加以控制。而服务对该代理是无感知的。应用程序（服务）应关注于业务逻辑，非功能需求交给 Service Mesh。  
3. Sidecar 模式，为每一个应用容器部署一个伴生容器，以 Kubernetes 集群中的应用为例，会在每一个 Pod 中运行一个 Sidecar 容器，与 Pod 中的应用容器共享存储和网络资源，类似每一个 Pod 中都运行着的 pause 容器，只不过 Sidecar 容器有其独特的作用。
   ![SOFAMesh](https://jimmysong.io/istio-handbook/images/006tNbRwgy1fuyr4vizzwj31kw1biq98.jpg)    
   例如图中，MOSN 作为 Sidecar 的方式和应用运行在同一个 Pod 中，拦截所有进出应用容器的流量，SOFAMesh 兼容 Istio，其中使用 Go 语言开发的 SOFAMosn 替换了 Envoy。
4. Sidecar 容器的流量劫持是通过 iptables 转发实现的。   

## Java Project on Kubernetes
[Sample java web system on Kubernetes](https://medium.com/@dayan888/sample-java-web-system-on-kubernetes-e52069390916)
[Debug Java Application on Kubernetes](https://dev.to/sandrogiacom/kubernetes-for-java-developers-debug-application-4l1a)

## Mircoservice without Kubernetes
[Microservice Architectures With Spring Cloud and Docker](https://dzone.com/articles/microservice-architecture-with-spring-cloud-and-do)

## Spring Cloud 微服务常见组件
Spring Cloud 是一种微服务规范，它规定了微服务架构的基本组件的类型，不同的微服务实现，采用的基本组件可能不一样。
Spring Cloud 规定微服务需要以下组件。
1. 服务网关，例如 Zuul, Spring Cloud Gateway
2. 服务注册与发现，例如 Eureka, Consul, Nacos
3. 配置中心, 例如 Spring Cloud Config
4. 服务容错管理，例如 Hystrix
5. 服务调用，例如 Feign, Dubbo
6. 日志收集，例如 Spring Cloud Sleuth+ELK, fluentd/Istio, LogStash
7. 调用链监控，skywalking
8. metrics监控：prometheus+spring actuator

Kubernetes 中相对应的组件，可以参见下表  

|   关注点    |   Spring Cloud | Kubernetes |
| :-----------| :---------- | :----------  |
| 自愈和自动伸缩 | 无 | kube-controller-manager |
| 调度和发布 	 | 无 	| kube-scheduler+Deployment  |
| 配置管理 		| Spring Cloud Config/Nacos |  ConfigMap |
| 服务发现和LB  | Eureka/Nacos | Service+CoreDNS/Istio   |
| 弹性和容错 	 | Hystrix/Resillience4j 	| Istio     |
| API网关 	    | Zuul/Spring Cloud Gateway  | Ingress/Istio Gateway |
| 服务安全 	    | Spring Cloud Security 	|  Istio |
| 调用链监控 	 | Spring Cloud Sleuth+ZipKin  | Istio+Jaeger/ZipKin  |
| Metrics监控  | actuator+Spring Boot Admin  | Istio+Prometheus |
| 日志收集 		| Spring Cloud Sleuth+ELK 	    | fluentd/Istio |


