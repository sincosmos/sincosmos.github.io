---
layout:     post
title:      一次面试准备
subtitle:   部分内容的复习
date:       2020-06-23
author:     sincosmos
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - Java, 分布式系统
---  

## 分布式系统
重读《分布式架构：原理、设计与实战》一书，伴随阅读之前的读书笔记 [微服务]() 一文
重温 Java SPI，桥接模式 
重温 Java NIO
重温 JVM 内存结构与内存模型


## 项目描述
1. LBS （Location Based Services）
本项目旨在提供打造并维护一份较为准确的用户离线地理位置信息（用户 -> 常驻地 居住地/工作地 -> 商圈/地铁/办公区）的数据仓库，基于这份数据可以提供一些广告投放服务的依据。和实时位置服务相比，常驻地地理位置信息在某些广告投放场景有独特的优势，例如商户向工作地在其周边的用户推送工作餐/外送水果/咖啡的广告，商场向居住地在其周边的用户推送周末商演广告等。
我们的数据源都是 hive 表，有用户地理位置信息（经纬度）记录表，京东房产部门维护全国主要城市小区经纬度记录表，城市地铁坐标表，城市商圈坐标表等。这些表有的按天记录，有的按周记录；有的是增量表，有的是全量表；有的表中的坐标是腾讯地图坐标，有的是国标地图坐标；有的表很大例如用户地理位置信息记录表，每天几百亿条记录，在 HDFS 上占据着几百 G 乃至上 T 的空间，有的比较小例如城市地铁坐标表，全量数据只有几十 M；有的是原始记录，数据比较粗糙，有的是经过精心维护的数据。
我们首先做了数据清洗工作。从存储用户地理位置信息（经纬度）记录表筛选出我们需要的列，并将数据存储格式从原来的 textFile 改成 ORC 列式存储，对部分字段进行分区排序，并对用户 ID, deviceId 等字段建立布隆过滤器索引，为将来高效率的查询提供支持，由于数据源表是每天增量更新的，因此我们的 ETL 表也建立了定时更新任务。在对用户地理位置信息 ETL 的过程中，我们还结合后续的需求，根据用户的经纬度坐标，生成了 geohash 值。geohash 值是为了更高效地根据用户地理位置记录找到用户的居住地和工作地，进而更高效地匹配到居住地所在小区，工作地所在办公区等。
具体到一个用户来说，直观地可以用其过去三个月的坐标记录（3*30*10000 条记录），通过聚类算法计算出三个聚集点。但聚类算法是通过迭代进行计算的，时间复杂度较高，对几亿用户的百万坐标点进行聚类计算需要消耗大量的计算资源和时间。因此结合地理位置经纬度有限这个特点，我们将二维的经纬度坐标转化成一维的 geohash，合理控制精度，采用周边8格解决边界问题，通过简单的 groupBy 就能将用户坐标集中出现的点找出来，从而找到用户的常驻地信息。
找到用户的常驻地坐标后，需要结合商圈/地铁/小区表，生成用户地标地理位置关系表。这个过程也是 ETL 的过程，join 行为较多，这个过程我们主要解决发生的数据倾斜问题。Spark Driver 将数据处理 task 分配到不同 Executor（计算节点），分配规则可能是根据就近原则，或者根据指定字段的 hash 值分配。那么当数据源文件大小差异较大、或指定字段 hash 值分配不均匀时就容易产生某些计算节点需要进行的计算任务远超其它节点。  
对于文件大小差异导致的数据倾斜，我们最好在生产数据时分配好每个文件的大小。  
Shuffle 并行度设置也会导致数据倾斜，这是因为 Spark 默认使用 HashPartitioner 对数据进行分区，它会计算数据 id 的 hash 后对并行度取模的值决定它将被发送到哪个 executor 的哪个 task，如果大量数据 id 的 hash 值对并行度取模的结果一样（hash值不一样，但对并行度取模结果一样），那么将导致它们被发送到同一个 task 执行，进而导致数据倾斜。此时可以通过修改并行度，或自定义 partitioner 取代 HashPartitioner，解决数据倾斜问题。但如果是由于大量数据拥有重复的数据 id 导致的数据倾斜，对所以 id 加上随机前缀进行初步的聚合，然后再通过 map 操作将前缀去掉进行最终的聚合操作。大表与小表 join 时，可 broadcast 小表，将 redcue side join 转化为 map side join 解决数据倾斜问题。

最终生成用户地理位置信息和地标的对应关系表，按周增量更新，供业务方使用。
2. 粉丝头条优化
大服务微服务化，引入领域驱动模型降低业务复杂导致的理解困难。
领域知识：人群圈选方式作为商品的核心特征，加入购物车的概念。

